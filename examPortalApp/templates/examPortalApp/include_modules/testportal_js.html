
  <script type="text/javascript">

    var unsaved=false;

    function answerChange() {
      unsaved=true;
    }

    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function startTimer(datetime, displays) {
      console.log(displays);
      var start = Date.now(),
        diff,
        minutes,
        seconds;
      function timer() {

        diff = ((datetime - Date.now()) / 1000);

        // does the same job as parseInt truncates the float
        hours = (diff / (60 * 60)) | 0;
        diff = (diff % (60 * 60)) | 0;
        minutes = (diff / 60) | 0;
        seconds = (diff % 60) | 0;
        for (var i=0; i<displays.length; i++) {
          if (hours > 0) {
            displays[i].innerHTML = "<b>Timer</b>  " + hours + ":" + minutes.toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ":" + seconds.toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
          }
          else if (minutes > 0) {
            displays[i].innerHTML = "<b>Timer</b>  " + minutes + ":" + seconds.toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
          }
          else {
            displays[i].innerHTML = "<b>Timer</b>  " + seconds + " seconds";
          }
        }
        if ((datetime - Date.now()) <= 0) {
          clearInterval(intervalVar);
          location.reload();
        }
      };
      // we don't want to wait a full second before the timer starts
      timer();
      var intervalVar = setInterval(timer, 1000);
    };


    window.onload = function () {
      var d = new Date();
      d.setUTCDate({{ UTCDate }});
      d.setUTCMonth({{ UTCMonth }}-1);
      d.setUTCFullYear({{ UTCYear }});
      d.setUTCHours({{ UTCHours }});
      d.setUTCMinutes({{ UTCMinutes }});
      d.setUTCSeconds({{ UTCSeconds }});
      console.log(d);
      var timer_display = document.querySelectorAll('.time');
      startTimer(d.getTime(), timer_display);
      // var que_display = document.querySelector('#nav-questions')
      // display_question_numbers(que_display);
    };

    var currentQNo;


    function getQuestion(questionNumber) {
      if (!unsaved)
      {
        window.location=(("{% url 'test_no' qnumber=1 %}").substring(0, ("{% url 'test_no' qnumber=1 %}").length - 1) + questionNumber);
      }
      else {
        saveChangesPopup(("{% url 'test_no' qnumber=1 %}").substring(0, ("{% url 'test_no' qnumber=1 %}").length - 1) + questionNumber);
      }
    }

    function nextQuestion() {
      if (currentQNo < {{ QCount }})
      {
        currentQNo += 1;
        getQuestion(currentQNo);
        // Qactive(currentQNo);
      }
    }

    function prevQuestion() {
      if (currentQNo > 1) {
        currentQNo -= 1;
        getQuestion(currentQNo);
        // Qactive(currentQNo);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      currentQNo = {{ QNum }};
      if (currentQNo == 1) {
        document.getElementById('prev').setAttribute("disabled", "disabled");
        document.getElementById('prev').style.opacity=0.5;
      }
      if (currentQNo == {{ QCount }})
      {
        document.getElementById('next').setAttribute("disabled", "disabled");
        document.getElementById('next').style.opacity=0.5;
      }

      // testportal

      var syncBtnList=document.querySelectorAll(".sync-btn")
      for(var i = 0; i < syncBtnList.length; i++) {
        syncBtnList[i].onclick= ()=>{
          if (unsaved) {
            saveChangesPopup(window.location.href)
          }
          else {
            location.reload();
          }
        };
      }
      document.getElementById('img-submit-popup-continue').onclick=()=>{
        document.getElementById('img-form').submit();
      };
      document.getElementById('txt-submit-popup-continue').onclick=()=>{
        document.getElementById('txt-form').submit();
      };
      var closePopupList = document.querySelectorAll(".close-popup");
      for(var i = 0; i < closePopupList.length; i++) {
        closePopupList[i].onclick = closePopup.bind(this, closePopupList[i]);
      }
      var navBtnList = document.querySelectorAll(".nav-btn");
      for(var i = 0; i < navBtnList.length; i++) {
        navBtnList[i].onclick = getQuestion.bind(this, parseInt(navBtnList[i].innerHTML));
      }
      var mcqBtnList = document.querySelectorAll(".mcq-btn");
      for(var i = 0; i < mcqBtnList.length; i++) {
        mcqBtnList[i].oninput = answerChange;
      }
      var ttBtnList = document.querySelectorAll(".tt-btn");
      for(var i = 0; i < ttBtnList.length; i++) {
        ttBtnList[i].oninput = answerChange;
      }
      var clearResponseBtn=document.getElementById('clear-response-btn');
      if (clearResponseBtn) {
        clearResponseBtn.onclick = resetForm.bind(this, clearResponseBtn.form);
      }

      var markReviewBtn = document.querySelector(".mark-review");
      if (markReviewBtn) {
        markReviewBtn.onclick = markReview;
      }
      var markAnsweredBtn = document.querySelector(".mark-answered");
      if (markAnsweredBtn) {
        markAnsweredBtn.onclick = markAnswered;
      }
      var markedBtn = document.querySelector(".marked");
      if (markedBtn) {
        markedBtn.onclick = markUnanswered;
      }

      document.getElementById('prev').onclick = prevQuestion;
      document.getElementById('next').onclick = nextQuestion;
      var viewImgBtnList = document.querySelectorAll(".view-img-btn");
      for(var i = 0; i < viewImgBtnList.length; i++) {
        viewImgBtnList[i].onclick = viewImage.bind(this, viewImgBtnList[i]);
      }
      var delImgBtnList = document.querySelectorAll(".del-img-btn");
      for(var i = 0; i < delImgBtnList.length; i++) {
        delImgBtnList[i].onclick = deleteImage.bind(this, delImgBtnList[i]);
      }
      var moveImgUpBtnList = document.querySelectorAll(".move-img-up-btn");
      for(var i = 0; i < moveImgUpBtnList.length; i++) {
        moveImgUpBtnList[i].onclick = moveAnswerUp.bind(this, moveImgUpBtnList[i]);
      }
      var moveImgDownBtnList = document.querySelectorAll(".move-img-down-btn");
      for(var i = 0; i < moveImgDownBtnList.length; i++) {
        moveImgDownBtnList[i].onclick = moveAnswerDown.bind(this, moveImgDownBtnList[i]);
      }
      var answerTextarea = document.getElementById('answer-textarea');
      if (answerTextarea) {
        answerTextarea.oninput = answerChange;
      }

      // forms_card
      var imgUploadTabBtn = document.getElementById('img-upload-tab-btn');
      if (imgUploadTabBtn) {
        imgUploadTabBtn.onclick = activateImgUploadForm;
      }
      var typeboxUploadTabBtn = document.getElementById('typebox-upload-tab-btn');
      if (typeboxUploadTabBtn) {
        typeboxUploadTabBtn.onclick = activateTextboxForm;
      }
      var uploadField = document.getElementById("id_file");

      if (uploadField)
      {
        uploadField.onchange = function() {
            if(this.files[0].size > 1572864000){
               alert("File is too big!");
               this.value = "";
            };
        };
      }

    });

    function saveChangesPopup(url) {
      document.getElementById('save-changes-popup').style.display="block";
      document.getElementById('save-changes-popup-continue').onclick=()=>{
        window.location=url;
      };
    }

    function closePopup(ele) {
      ele.closest('.popup').style.display="none";
    }

    function markAnswered() {
      if (!unsaved)
      {
        window.location=(("{% url 'answered' qnumber=1 %}").substring(0, ("{% url 'answered' qnumber=1 %}").length - 1) + currentQNo);
      }
      else {
        saveChangesPopup(("{% url 'answered' qnumber=1 %}").substring(0, ("{% url 'answered' qnumber=1 %}").length - 1) + currentQNo);
      }
    }

    function markReview() {
      if (!unsaved) {
        window.location=(("{% url 'review' qnumber=1 %}").substring(0, ("{% url 'review' qnumber=1 %}").length - 1) + currentQNo);
      }
      else {
        saveChangesPopup(("{% url 'review' qnumber=1 %}").substring(0, ("{% url 'review' qnumber=1 %}").length - 1) + currentQNo);
      }
    }

    function markUnanswered() {
      if (!unsaved) {
        window.location=(("{% url 'unanswered' qnumber=1 %}").substring(0, ("{% url 'unanswered' qnumber=1 %}").length - 1) + currentQNo);
      }
      else {
        saveChangesPopup(("{% url 'unanswered' qnumber=1 %}").substring(0, ("{% url 'unanswered' qnumber=1 %}").length - 1) + currentQNo);
      }
    }

    function viewImage(ele) {
      console.log(ele);
      console.log(ele.parentElement);
      document.getElementById('view-img-popup').style.display = "block";
      document.getElementById('answer-img-container').innerHTML = "Loading... <br>";
      page_no=ele.parentElement.dataset.pageno;
      fetch(("{% url 'get_answer' qnumber=1 page_no=1 %}").substring(0, ("{% url 'get_answer' qnumber=1 page_no=1 %}").length - 3) + currentQNo + '/' + page_no)
        .then(response => response.json())
        .then((data) => {
          var URI = data["image"];
          document.getElementById('answer-img-container').innerHTML = "<img src='" + URI + "'>";
        })
    }

    function deleteImage(ele) {
      let page_no=ele.parentElement.dataset.pageno;
      ele.removeAttribute('onclick');
      document.querySelector(".card").style.opacity=0.5;
      let csrftoken = getCookie('csrftoken');
      fetch(("{% url 'del_answer' qnumber=1 page_no=1 %}").substring(0, ("{% url 'del_answer' qnumber=1 page_no=1 %}").length - 3) + currentQNo + '/' + page_no, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: null
      })
        .then(response => {
          location.reload();
        })
    }

    async function moveAnswerUp(ele) {
      let page_no=ele.parentElement.dataset.pageno;
      ele.removeAttribute('onclick');
      document.querySelector(".card").style.opacity=0.5;
      let csrftoken = getCookie('csrftoken');
      let response= await fetch("{% url 'move_up' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({"qnumber":currentQNo, "page_no": page_no})
      })
      location.reload();
    }

    async function moveAnswerDown(ele) {
      let page_no=ele.parentElement.dataset.pageno;
      ele.removeAttribute('onclick');
      document.querySelector(".card").style.opacity=0.5;
      let csrftoken = getCookie('csrftoken');
      let response= await fetch("{% url 'move_down' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({"qnumber":currentQNo, "page_no": page_no})
      })
      location.reload();
    }

    function resetForm(form) {
    // clearing inputs
      answerChange();
      var inputs = form.getElementsByTagName('input');
      for (var i = 0; i<inputs.length; i++) {
          switch (inputs[i].type) {
              // case 'hidden':
              case 'text':
                  inputs[i].value = '';
                  break;
              case 'radio':
              case 'checkbox':
                  inputs[i].checked = false;
          }
      }

      // clearing selects
      var selects = form.getElementsByTagName('select');
      for (var i = 0; i<selects.length; i++)
          selects[i].selectedIndex = 0;

      // clearing textarea
      var text= form.getElementsByTagName('textarea');
      for (var i = 0; i<text.length; i++)
          text[i].innerHTML= '';

      return false;
  }

  function activateTextboxForm() {
    document.getElementById('typebox-upload-tab-body').style.display="block";
    document.getElementById('img-upload-tab-body').style.display="none";
    document.getElementById('typebox-upload-tab-btn').classList.add('active');
    document.getElementById('img-upload-tab-btn').classList.remove('active');
    return false;
  }

  function activateImgUploadForm() {
    document.getElementById('typebox-upload-tab-body').style.display="none";
    document.getElementById('img-upload-tab-body').style.display="block";
    document.getElementById('typebox-upload-tab-btn').classList.remove('active');
    document.getElementById('img-upload-tab-btn').classList.add('active');
    return false;
  }

//   function openCameraPopup() {
//     document.getElementById('camera-popup').style.display="block";
//   }
//
//   function closeCamPopup(ele) {
//     closePopup(ele);
//   }
//
//   function b64toBlob(b64Data, contentType, sliceSize) {
//     contentType = contentType || '';
//     sliceSize = sliceSize || 512;
//
//     var byteCharacters = atob(b64Data);
//     var byteArrays = [];
//
//     for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
//       var slice = byteCharacters.slice(offset, offset + sliceSize);
//
//       var byteNumbers = new Array(slice.length);
//       for (var i = 0; i < slice.length; i++) {
//         byteNumbers[i] = slice.charCodeAt(i);
//       }
//
//       var byteArray = new Uint8Array(byteNumbers);
//
//       byteArrays.push(byteArray);
//     }
//
//   var blob = new Blob(byteArrays, {type: contentType});
//   return blob;
// }
//
//   function sendWebcamData(data) {
//     var ImageURL=data
//     var block = ImageURL.split(";");
//     // Get the content type of the image
//     var contentType = block[0].split(":")[1];// In this case "image/gif"
//     // get the real base64 content of the file
//     var realData = block[1].split(",")[1];// In this case "R0lGODlhPQBEAPeoAJosM...."
//
//     // Convert it to a blob to upload
//     var blob = b64toBlob(realData, contentType);
//
//     var redirect = function(url, method) {
//       var form = document.createElement('form');
//       form.method = method;
//       form.action = url;
//       form.innerHTML+='{% csrf_token %}';
//       var input1 = document.createElement('input');
//       input1.type = 'hidden';
//       input1.name = "qnumber";
//       input1.value = "{{ QNum }}";
//       form.appendChild(input1);
//       var input2 = document.createElement('input');
//       input2.type = 'file';
//       input2.name = "file";
//       input2.value = blob;
//       form.appendChild(input2);
//       document.body.appendChild(form);
//       form.submit();
//     };
//
//     redirect('{% url 'upload_answer' %}', 'post');
//   }

  function imgFormSubmit(e) {
    e.preventDefault();
    var d=document.createElement('DIV');
    d.innerHTML=("{{answer_text|linebreaks}}").trim();
    if (d.textContent.trim()==="") {
      document.getElementById('img-form').submit();
    }
    else {
      openImgSubmitPopup();
      return false;
    }
  }

  function txtFormSubmit(e) {
    e.preventDefault();
    if ({{uploaded_files|length}}==0) {
      document.getElementById('txt-form').submit();
    }
    else {
      openTxtSubmitPopup();
      return false;
    }
  }

  function openImgSubmitPopup() {
    document.getElementById('img-submit-popup').style.display="block";

  }

  function openTxtSubmitPopup() {
    document.getElementById('txt-submit-popup').style.display="block";
  }


</script>
