
<script type="text/javascript">

  if (location.protocol !== 'https:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
  }

  const roomName='{{team.sequence}}';
  const ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";

  var unsaved=false;

  function answerChange() {
    unsaved=true;
  }

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function startTimer(datetime, displays) {
    var diff0,
      diff,
      minutes,
      seconds;
    function timer() {

      diff0 = ((datetime - Date.now()) / 1000);
      diff = diff0;
      if (diff0>20*60) {
        diff-=20*60;
      }

      // does the same job as parseInt truncates the float
      hours = (diff / (60 * 60)) | 0;
      diff = (diff % (60 * 60)) | 0;
      minutes = (diff / 60) | 0;
      seconds = (diff % 60) | 0;

      for (var i=0; i<displays.length; i++) {
        if (hours > 0) {
          displays[i].innerHTML = hours + ":" + minutes.toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + ":" + seconds.toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
        }
        else if (minutes > 0) {
          displays[i].innerHTML = minutes + ":" + seconds.toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
        }
        else {
          displays[i].innerHTML = seconds + " seconds";
        }
        if (diff0>20*60) {
          if (hours > 0) {
            displays[i].innerHTML += " + 00:20:00";
          }
          else {
            displays[i].innerHTML += " + 20:00";
          }
        }
        else {
          displays[i].innerHTML += " (Uploading Time)";
        }
      }
      if ((datetime - Date.now()) <= 0) {
        console.log(datetime);
        console.log(Date.now());
        clearInterval(intervalVar);
        location.reload();
      }
    };
    // we don't want to wait a full second before the timer starts
    timer();
    var intervalVar = setInterval(timer, 1000);
  };


  window.onload = function () {
    var d = new Date();
    var now = new Date(Date.now());
    d.setUTCDate({{ UTCDate }}+(now.getUTCDate()-{{UTCDateNow}}));
    d.setUTCMonth({{ UTCMonth }}+(now.getUTCMonth()-{{UTCMonthNow}}));
    d.setUTCFullYear({{ UTCYear }}+(now.getUTCFullYear()-{{UTCYearNow}}));
    d.setUTCHours({{ UTCHours }}+(now.getUTCHours()-{{UTCHoursNow}}));
    d.setUTCMinutes({{ UTCMinutes }}+(now.getUTCMinutes()-{{UTCMinutesNow}}));
    d.setUTCSeconds({{ UTCSeconds }}+(now.getUTCSeconds()-{{UTCSecondsNow}}));
    var timer_display = document.querySelectorAll('.time');
    startTimer(d.getTime(), timer_display);
    // var que_display = document.querySelector('#nav-questions')
    // display_question_numbers(que_display);
  };

  var currentQNo;
  var answer_text="";

  function anandsInteractiveThing() {
    const canvas=document.getElementById("grid"),ctx=canvas.getContext("2d"),screenWidth=canvas.width,screenHeight=canvas.height,blockWidth=25,blockHeight=25;var play=!1,waitTime=150;ctx.strokeStyle="dimgray",cellGrid=[];class Cell{constructor(e,t){this.isActive=!1,this.x=e,this.y=t,this.color="white"}draw(){ctx.fillStyle=this.color,ctx.beginPath(),ctx.rect(this.x,this.y,blockWidth,blockHeight),ctx.stroke(),ctx.fill(),ctx.closePath()}update(e){this.isActive=e,this.color=e?"black":"white",this.draw()}toggle(){this.update(!this.isActive)}neighbors(){return neighborhood(Math.floor(this.x/blockWidth),Math.floor(this.y/blockHeight))}nextState(){var e=0,t=this.neighbors();console.log("Cell: "+this.x+", "+this.y+" ; Neighbours: "+t);for(var l=0;l<t.length;l++)e+=t[l].isActive;return 1==mod(e,2)}}function initializeGrid(){for(var e=0;e<screenWidth;e+=blockWidth){row=[];for(var t=0;t<screenHeight;t+=blockHeight)newCell=new Cell(e,t),row.push(newCell),newCell.draw();cellGrid.push(row)}}function mod(e,t){return 0<=e&&e<t?e:mod(e<0?e+t:e-t,t)}function neighborhood(e,t){return cell=cellGrid[e][t],[cellGrid[mod(e-1,cellGrid[e].length)][t],cellGrid[mod(e+1,cellGrid[e].length)][t],cellGrid[e][mod(t-1,cellGrid.length)],cellGrid[e][mod(t+1,cellGrid.length)]]}function updateBoard(){if(play){futureStates=[];for(const t of cellGrid){var e=[];for(const l of t)e.push(l.nextState());futureStates.push(e)}for(var t=0;t<cellGrid.length;t++)for(var l=0;l<cellGrid[t].length;l++)0!=t&&t!=cellGrid.length-1&&0!=l&&l!=cellGrid[t].length-1||!cellGrid[t][l].isActive||(stopGame(),document.getElementById("messagelog").innerHTML="The cells have reached the edges of the board."),cellGrid[t][l].update(futureStates[t][l])}}function mouseDraw(e){var t=canvas.getBoundingClientRect();mx=Math.floor((e.clientX-t.left)/blockWidth),my=Math.floor((e.clientY-t.top)/blockHeight),cellGrid[mx][my].toggle()}function playPause(){play=!play,document.getElementById("playpausebutton").innerHTML=play?"PAUSE":"PLAY"}function stopGame(){play=!1,document.getElementById("playpausebutton").innerHTML="PLAY"}function resetBoard(){stopGame(),document.getElementById("messagelog").innerHTML="";for(var e=0;e<cellGrid.length;e++)for(var t=0;t<cellGrid[0].length;t++)cellGrid[e][t].update(!1)}function playGame(){initializeGrid(),canvas.addEventListener("mousedown",mouseDraw),automaton=setInterval(function(){updateBoard()},waitTime)}window.onload=playGame();document.addEventListener("pointerdown", (e)=>{mouseDraw(e)})
  }

  function getQuestion(questionNumber) {
    if (!unsaved) {
      document.getElementById('loading-overlay').style.display="block";
      let csrftoken = getCookie('csrftoken');
      fetch("{% url 'get_question' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({"qnumber":questionNumber})
      })
      .then((response) => {
        return response.json()
      })
      .then((data) => {

        document.getElementById('q-content').innerHTML=data["question"];
        document.querySelector('.answer-section').innerHTML=data["answer"];
        if (document.getElementById('answer-textarea')) {
          answer_text=document.getElementById('answer-textarea').value;
        }
        else {
          answer_text="";
        }
        document.getElementById("q-btn-"+currentQNo).classList.remove('active');
        document.getElementById("q-btn-"+currentQNo).classList.remove('visited');
        currentQNo=questionNumber;
        document.getElementById("q-btn-"+currentQNo).classList.add('active');
        document.getElementById("q-btn-"+currentQNo).classList.add('visited');
        let forms=document.querySelectorAll(".answer-section-form");
        for (var i = 0; i < forms.length; i++) {
          forms[i].innerHTML='<input type="hidden" name="csrfmiddlewaretoken" value="'+"{{csrf_token}}"+'">'+forms[i].innerHTML;
        }
        // markQuestion.send(JSON.stringify({
        //   "qnumber": currentQNo,
        //   "status" : "visit",
        //   "username" : "{{user.username}}",
        // }));
        initQuestionJS();
        document.getElementById('loading-overlay').style.display="none";
        if (questionNumber==5) {
          anandsInteractiveThing();
        }
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }
    else {
      saveChangesPopup(()=>{
        unsaved=false;
        getQuestion(questionNumber);
      })
    }

  }

  function nextQuestion() {
    if (currentQNo < {{ QCount }})
    {
      getQuestion(currentQNo+1);
      // Qactive(currentQNo);
    }
  }

  function prevQuestion() {
    if (currentQNo > 1) {
      getQuestion(currentQNo-1);
      // Qactive(currentQNo);
    }
  }



  function initQuestionJS() {
    if (currentQNo == 1) {
      document.getElementById('prev').setAttribute("disabled", "disabled");
      document.getElementById('prev').style.opacity=0.5;
    }
    else {
      document.getElementById('prev').removeAttribute("disabled");
      document.getElementById('prev').style.opacity=1;
    }
    if (currentQNo == {{ QCount }})
    {
      document.getElementById('next').setAttribute("disabled", "disabled");
      document.getElementById('next').style.opacity=0.5;
    }
    else {
      document.getElementById('next').removeAttribute("disabled");
      document.getElementById('next').style.opacity=1;
    }

    // testportal

    var syncBtnList=document.querySelectorAll(".sync-btn")
    for(var i = 0; i < syncBtnList.length; i++) {
      syncBtnList[i].onclick= ()=>{
        getQuestion(currentQNo);
      };
    }

    // document.getElementById('img-submit-popup-continue').onclick=()=>{
    //   document.getElementById('img-submit-popup-continue').innerHTML="Processing request...";
    //   document.getElementById('img-submit-popup-continue').style.opacity=0.5;
    //   document.getElementById('img-submit-popup-continue').disabled=true;
    //   document.getElementById('img-submit-popup-continue').onclick= function() {
    //     return false;
    //   };
    //   var closePopupList = document.querySelectorAll(".close-popup");
    //   for(var i = 0; i < closePopupList.length; i++) {
    //     closePopupList[i].style.opacity=0.5;
    //     closePopupList[i].disabled=true;
    //     closePopupList[i].onclick = function() {
    //       return false;
    //     };
    //   }
    //   document.getElementById('img-form').submit();
    // };
    document.getElementById('txt-submit-popup-continue').onclick=()=>{
      document.getElementById('txt-submit-popup-continue').innerHTML="Processing request...";
      document.getElementById('txt-submit-popup-continue').style.opacity=0.5;
      document.getElementById('txt-submit-popup-continue').disabled=true;
      document.getElementById('txt-submit-popup-continue').onclick= function() {
        return false;
      };
      var closePopupList = document.querySelectorAll(".close-popup");
      for(var i = 0; i < closePopupList.length; i++) {
        closePopupList[i].style.opacity=0.5;
        closePopupList[i].disabled=true;
        closePopupList[i].onclick = function() {
          return false;
        };
      }
      document.getElementById('loading-overlay').style.display="block";
      let form=document.getElementById('txt-form');
      fetch(form.action, {
        method: form.method,
        body: new FormData(form),
      })
      .then(()=>{
        unsaved=false;
        document.getElementById('loading-overlay').style.display="none";
        getQuestion(currentQNo);
      });
    };
    var closePopupList = document.querySelectorAll(".close-popup");
    for(var i = 0; i < closePopupList.length; i++) {
      closePopupList[i].style.opacity=1;
      closePopupList[i].disabled=false;
      closePopupList[i].onclick = closePopup.bind(this, closePopupList[i]);
    }
    var popupList = document.querySelectorAll(".popup");
    for(var i = 0; i < popupList.length; i++) {
      if (popupList[i].id!="start-screen") {
        popupList[i].style.display="none";
      }
    }
    var navBtnList = document.querySelectorAll(".nav-btn");
    for(var i = 0; i < navBtnList.length; i++) {
      navBtnList[i].onclick = getQuestion.bind(this, parseInt(navBtnList[i].innerHTML));
    }
    var mcqBtnList = document.querySelectorAll(".mcq-btn");
    for(var i = 0; i < mcqBtnList.length; i++) {
      mcqBtnList[i].oninput = answerChange;
    }
    var ttBtnList = document.querySelectorAll(".tt-btn");
    for(var i = 0; i < ttBtnList.length; i++) {
      ttBtnList[i].oninput = answerChange;
    }
    var clearResponseBtn=document.getElementById('clear-response-btn');
    if (clearResponseBtn) {
      clearResponseBtn.onclick = resetForm.bind(this, clearResponseBtn.form);
    }

    var clearToTOptionBtn=document.getElementById('clear-tot-opt-btn');
    if (clearToTOptionBtn) {
      clearToTOptionBtn.onclick=clearToTOption;
    }

    var markReviewBtn = document.querySelector(".mark-review");
    if (markReviewBtn) {
      markReviewBtn.onclick = markReview;
    }
    var markAnsweredBtn = document.querySelector(".mark-answered");
    if (markAnsweredBtn) {
      markAnsweredBtn.onclick = markAnswered;
    }
    var markedBtn = document.querySelector(".marked");
    if (markedBtn) {
      markedBtn.onclick = markUnanswered;
    }

    document.getElementById('prev').onclick = prevQuestion;
    document.getElementById('next').onclick = nextQuestion;
    var viewImgBtnList = document.querySelectorAll(".view-img-btn");
    for(var i = 0; i < viewImgBtnList.length; i++) {
      viewImgBtnList[i].onclick = viewImage.bind(this, viewImgBtnList[i]);
    }
    var delImgBtnList = document.querySelectorAll(".del-img-btn");
    for(var i = 0; i < delImgBtnList.length; i++) {
      delImgBtnList[i].onclick = deleteImage.bind(this, delImgBtnList[i]);
    }
    var moveImgUpBtnList = document.querySelectorAll(".move-img-up-btn");
    for(var i = 0; i < moveImgUpBtnList.length; i++) {
      moveImgUpBtnList[i].onclick = moveAnswerUp.bind(this, moveImgUpBtnList[i]);
    }
    var moveImgDownBtnList = document.querySelectorAll(".move-img-down-btn");
    for(var i = 0; i < moveImgDownBtnList.length; i++) {
      moveImgDownBtnList[i].onclick = moveAnswerDown.bind(this, moveImgDownBtnList[i]);
    }
    var answerTextarea = document.getElementById('answer-textarea');
    if (answerTextarea) {
      answerTextarea.oninput = answerChange;
    }

    // forms_card
    var imgUploadTabBtn = document.getElementById('img-upload-tab-btn');
    if (imgUploadTabBtn) {
      imgUploadTabBtn.onclick = activateImgUploadForm;
    }
    var typeboxUploadTabBtn = document.getElementById('typebox-upload-tab-btn');
    if (typeboxUploadTabBtn) {
      typeboxUploadTabBtn.onclick = activateTextboxForm;
    }
    var uploadField = document.getElementById("id_file");

    if (uploadField)
    {
      uploadField.onchange = function() {
          if(this.files[0].size > 1572864000){
             alert("File is too big!");
             this.value = "";
          };
      };
    }

    if (document.getElementById('open-cam-btn')) {
      console.log("heya");
      document.getElementById('open-cam-btn').onclick = ()=>{
        openCameraPopup();
        camStartup();
      };
    }
    if (document.getElementById('upload-photo-btn')) {
      document.getElementById('upload-photo-btn').onclick = ()=>{
        uploadWebcamPicture();
      };
    }
  }


  var logSocket
  var markQuestion
  document.addEventListener("DOMContentLoaded", () => {
    function markQuestionConnect() {
      markQuestion = new WebSocket(
        ws_scheme+'://'
        + window.location.host
        + '/ws/mark-question/'
        + roomName
        + '/'
      );
    }
    markQuestionConnect();

    markQuestion.onmessage = function(e) {
      console.log("received data from server");
      const data = JSON.parse(e.data);
      console.log(data);
      if (data.status=="answered") {
        document.getElementById('q-btn-'+data.qnumber).classList.remove("btn-review");
        document.getElementById('q-btn-'+data.qnumber).classList.add("btn-answered");
        if (currentQNo==data.qnumber) {
          if (document.querySelector('.mark-answered')) {
            document.querySelector('.mark-answered').classList.add("marked");
            document.querySelector('.mark-answered').innerHTML="Marked as Answered";
          }
          document.querySelector('.mark-review').classList.remove("marked");
          document.querySelector('.mark-review').innerHTML="Mark for Review";
          initQuestionJS();
        }
      }
      else if (data.status=="review") {
        document.getElementById('q-btn-'+data.qnumber).classList.remove("btn-answered");
        document.getElementById('q-btn-'+data.qnumber).classList.add("btn-review");
        if (currentQNo==data.qnumber) {
          if (document.querySelector('.mark-answered')) {
            document.querySelector('.mark-answered').classList.remove("marked");
            document.querySelector('.mark-answered').innerHTML="Mark as Answered";
          }
          document.querySelector('.mark-review').classList.add("marked");
          document.querySelector('.mark-review').innerHTML="Marked for Review";
          initQuestionJS();
        }
      }
      else if (data.status=="unanswered") {
        document.getElementById('q-btn-'+data.qnumber).classList.remove("btn-answered");
        document.getElementById('q-btn-'+data.qnumber).classList.remove("btn-review");
        if (currentQNo==data.qnumber) {
          if (document.querySelector('.mark-answered')) {
            document.querySelector('.mark-answered').classList.remove("marked");
            document.querySelector('.mark-answered').innerHTML="Mark as Answered";
          }
          document.querySelector('.mark-review').classList.remove("marked");
          document.querySelector('.mark-review').innerHTML="Mark for Review";
          initQuestionJS();
        }
      }

    };

    var mark_connect_interval;

    markQuestion.onclose = function(e) {
      mark_connect_interval=setInterval(markQuestionConnect(), 4000);
      alert("Unstable connection, some features may not work properly. Attempting to reconnect...");
    };

    markQuestion.onopen = function (e) {
      if (mark_connect_interval !== undefined) {
        clearInterval(mark_connect_interval);
      }
    };

    function logSocketConnect() {
      logSocket = new WebSocket(
        ws_scheme+'://'
        + window.location.host
        + '/ws/log/'
        + roomName
        + '/'
      );
    }
    logSocketConnect()
    window.addEventListener('error', function(event) {
      console.log("error recorded");
      if (logSocket.readyState == 1) {
        console.log("error sent");
        logSocket.send(JSON.stringify({
          "log": JSON.stringify({"username":"{{user.username}}", "actionCommited": "encountered an error - "+event.message})
        }));
      }
    });
    var log_connect_interval;
    logSocket.onclose = function(e) {
      log_connect_interval=setInterval(logSocketConnect(), 4000);
      alert("Unstable connection, some features may not work properly. Attempting to reconnect...");
    }
    logSocket.onopen = function() {
      if (log_connect_interval !== undefined) {
        clearInterval(log_connect_interval);
      }
    }
    setTimeout(function () {
      if (logSocket.readyState == 1) {
        logSocket.send(JSON.stringify({
          "log": JSON.stringify({"username":"{{user.username}}", "actionCommited": "entered waiting room"})
        }));
      }
      else {
        setTimeout(function () {
          if (logSocket.readyState == 1) {
            logSocket.send(JSON.stringify({
              "log": JSON.stringify({"username":"{{user.username}}", "actionCommited": "entered waiting room"})
            }));
          }
          else {
            setTimeout(function () {
              if (logSocket.readyState == 1) {
                logSocket.send(JSON.stringify({
                  "log": JSON.stringify({"username":"{{user.username}}", "actionCommited": "entered waiting room"})
                }));
              }
            }, 5000)
          }
        }, 5000)
      }
    }, 5000)
    document.getElementById('chat-log').innerHTML="";
    {% for log in chat_logs %}
    document.getElementById('chat-log').innerHTML+="<div><b>{% if log.0 == team.proctor_user.username %}Proctor{% else %}{{log.0}}{% endif %}:</b>"+" {{log.1}}</div>";
    {% endfor %}
    document.getElementById('start-screen').style.display="block";
  });

  function saveChangesPopup(foo) {
    document.getElementById('save-changes-popup').style.display="block";
    document.getElementById('save-changes-popup-continue').onclick=()=>{
      document.getElementById('save-changes-popup-continue').innerHTML="Processing request...";
      document.getElementById('save-changes-popup-continue').style.opacity=0.5;
      document.getElementById('save-changes-popup-continue').disabled=true;
      document.getElementById('save-changes-popup-continue').onclick= function() {
        return false;
      };
      var closePopupList = document.querySelectorAll(".close-popup");
      for(var i = 0; i < closePopupList.length; i++) {
        closePopupList[i].style.opacity=0.5;
        closePopupList[i].disabled=true;
        closePopupList[i].onclick = function() {
          return false;
        };
      }
      initQuestionJS();
      document.getElementById('save-changes-popup-continue').innerHTML="Continue";
      document.getElementById('save-changes-popup-continue').style.opacity=1;
      document.getElementById('save-changes-popup-continue').disabled=false;
      foo();
    };
  }

  function closePopup(ele) {
    ele.closest('.popup').style.display="none";
  }

  function clearToTOption() {
    if (!unsaved)
    {
      document.getElementById('loading-overlay').style.display="block";
      let csrftoken = getCookie('csrftoken');
      fetch("{% url 'clear_t_options' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({"qnumber":currentQNo})
      })
      .then(() => {
        getQuestion(currentQNo);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }
    else {
      saveChangesPopup(()=>{
        unsaved=false;
        markAnswered();
      });
    }
  }


  function markAnswered() {
    if (!unsaved)
    {

      document.getElementById('loading-overlay').style.display="block";
      let csrftoken = getCookie('csrftoken');
      fetch("{% url 'answered' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({"qnumber":currentQNo})
      })
      .then(() => {
        document.getElementById('q-btn-'+currentQNo).classList.remove("btn-review");
        document.getElementById('q-btn-'+currentQNo).classList.add("btn-answered");
        getQuestion(currentQNo);
        markQuestion.send(JSON.stringify({
          "qnumber": currentQNo,
          "status" : "answered",
          "username" : "{{user.username}}",
        }));
        console.log("sent data from browser to server");
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }
    else {
      saveChangesPopup(()=>{
        unsaved=false;
        markAnswered();
      });
    }
  }

  function markReview() {

    if (!unsaved) {
      document.getElementById('loading-overlay').style.display="block";
      let csrftoken = getCookie('csrftoken');
      fetch("{% url 'review' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({"qnumber":currentQNo})
      })
      .then(() => {
        document.getElementById('q-btn-'+currentQNo).classList.remove("btn-answered");
        document.getElementById('q-btn-'+currentQNo).classList.add("btn-review");
        getQuestion(currentQNo);
        markQuestion.send(JSON.stringify({
          "qnumber": currentQNo,
          "status" : "review",
          "username" : "{{user.username}}",
        }));
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }
    else {
      saveChangesPopup(()=>{
        unsaved=false;
        markReview();
      });
    }
  }

  function markUnanswered() {
    if (!unsaved) {
      document.getElementById('loading-overlay').style.display="block";
      let csrftoken = getCookie('csrftoken');
      fetch("{% url 'unanswered' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({"qnumber":currentQNo})
      })
      .then(() => {
        document.getElementById('q-btn-'+currentQNo).classList.remove("btn-answered");
        document.getElementById('q-btn-'+currentQNo).classList.remove("btn-review");
        getQuestion(currentQNo);
        markQuestion.send(JSON.stringify({
          "qnumber": currentQNo,
          "status" : "unanswered",
          "username" : "{{user.username}}",
        }));
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    }
    else {
      saveChangesPopup(()=>{
        unsaved=false;
        markUnanswered();
      });
    }
  }

  function viewImage(ele) {
    document.getElementById('view-img-popup').style.display = "block";
    document.getElementById('answer-img-container').innerHTML = "Loading... <br>";
    page_no=ele.parentElement.parentElement.dataset.pageno;
    fetch(("{% url 'get_answer' qnumber=1 page_no=1 %}").substring(0, ("{% url 'get_answer' qnumber=1 page_no=1 %}").length - 3) + currentQNo + '/' + page_no)
      .then(response => response.json())
      .then((data) => {
        var URI = data["image"];
        document.getElementById('answer-img-container').innerHTML = "<img class='uploaded-img' src='" + URI + "'>";
      })
      .catch((error) => {
        console.error('Error:', error);
      });
  }

  function deleteImage(ele) {
    let page_no=ele.parentElement.parentElement.dataset.pageno;
    ele.removeAttribute('onclick');
    document.querySelector(".card").style.opacity=0.5;
    let csrftoken = getCookie('csrftoken');
    fetch(("{% url 'del_answer' qnumber=1 page_no=1 %}").substring(0, ("{% url 'del_answer' qnumber=1 page_no=1 %}").length - 3) + currentQNo + '/' + page_no, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        "X-CSRFToken": csrftoken
      },
      body: null
    })
    .then(response => {
      getQuestion(currentQNo);
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }

  async function moveAnswerUp(ele) {
    let page_no=ele.parentElement.parentElement.dataset.pageno;
    ele.removeAttribute('onclick');
    document.querySelector(".card").style.opacity=0.5;
    let csrftoken = getCookie('csrftoken');
    let response= await fetch("{% url 'move_up' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({"qnumber":currentQNo, "page_no": page_no})
    })
    getQuestion(currentQNo);
  }

  async function moveAnswerDown(ele) {
    let page_no=ele.parentElement.parentElement.dataset.pageno;
    ele.removeAttribute('onclick');
    document.querySelector(".card").style.opacity=0.5;
    let csrftoken = getCookie('csrftoken');
    let response= await fetch("{% url 'move_down' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify({"qnumber":currentQNo, "page_no": page_no})
    })
    getQuestion(currentQNo);
  }

  function resetForm(form) {
  // clearing inputs
    answerChange();
    var inputs = form.getElementsByTagName('input');
    for (var i = 0; i<inputs.length; i++) {
        switch (inputs[i].type) {
            // case 'hidden':
            case 'text':
                inputs[i].value = '';
                break;
            case 'radio':
            case 'checkbox':
                inputs[i].checked = false;
        }
    }
    // clearing selects
    var selects = form.getElementsByTagName('select');
    for (var i = 0; i<selects.length; i++)
    {
      selects[i].selectedIndex = 0;
    }
    // clearing textarea
    var text= form.getElementsByTagName('textarea');
    for (var i = 0; i<text.length; i++)
    {
      text[i].innerHTML= '';
    }
    return false;
  }

  function activateTextboxForm() {
    document.getElementById('typebox-upload-tab-body').style.display="block";
    document.getElementById('img-upload-tab-body').style.display="none";
    document.getElementById('typebox-upload-tab-btn').classList.add('active');
    document.getElementById('img-upload-tab-btn').classList.remove('active');
    return false;
  }

  function activateImgUploadForm() {
    document.getElementById('typebox-upload-tab-body').style.display="none";
    document.getElementById('img-upload-tab-body').style.display="block";
    document.getElementById('typebox-upload-tab-btn').classList.remove('active');
    document.getElementById('img-upload-tab-btn').classList.add('active');
    return false;
  }

  function openCameraPopup() {
    document.getElementById('camera-popup').style.display="block";
  }

  function closeCamPopup(ele) {
    closePopup(ele);
  }

  function b64toBlob(b64Data, contentType, sliceSize) {
    contentType = contentType || '';
    sliceSize = sliceSize || 512;

    var byteCharacters = atob(b64Data);
    var byteArrays = [];

    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      var slice = byteCharacters.slice(offset, offset + sliceSize);

      var byteNumbers = new Array(slice.length);
      for (var i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }

      var byteArray = new Uint8Array(byteNumbers);

      byteArrays.push(byteArray);
    }

    var blob = new Blob(byteArrays, {type: contentType});
    return blob;
  }

  function sendWebcamData(data) {
    var ImageURL=data
    console.log(ImageURL);
    var block = ImageURL.split(";");
    // Get the content type of the image
    var contentType = block[0].split(":")[1];// In this case "image/gif"
    // get the real base64 content of the file
    var realData = block[1].split(",")[1];// In this case "R0lGODlhPQBEAPeoAJosM...."

    // Convert it to a blob to upload
    var blob = b64toBlob(realData, contentType);
    console.log(blob);

    var redirect = function(url, method) {
      document.getElementById('loading-overlay').style.display="block";
      var form = document.createElement('form');
      form.method = method;
      form.action = url;
      form.enctype="multipart/form-data";
      form.innerHTML+='<input type="hidden" name="csrfmiddlewaretoken" value="{{csrf_token}}">';
      var input1 = document.createElement('input');
      input1.type = 'hidden';
      input1.name = "qnumber";
      input1.value = currentQNo;
      form.appendChild(input1);
      let file = new File([blob], "img.jpg",{type:"image/jpeg", lastModified:new Date().getTime()});
      let container = new DataTransfer();
      container.items.add(file);
      var input2 = document.createElement('input');
      input2.type = 'file';
      input2.name = "file";
      input2.files = container.files;
      form.appendChild(input2);
      document.body.appendChild(form);
      form.style.display="none";
      form.style.position="absolute";
      form.style.height=0;
      form.style.margin=0;
      form.style.padding=0;
      form.style.left= -9999;
      // form.submit();
      fetch(form.action, {
        method: form.method,
        body: new FormData(form),
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('upload-status-popup').innerHTML="<p>"+data.message+"</p>"+document.getElementById('upload-status-popup').innerHTML;
        document.getElementById('upload-status-popup').style.display="block";
        unsaved=false;
        document.getElementById('loading-overlay').style.display="none";
        getQuestion(currentQNo);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    };

    redirect('{% url 'upload_answer' %}', 'post');
  }


  // function uploadWebcamPicture() {
  //   let blob = await new Promise(resolve => document.getElementById('canvas').toBlob(resolve, 'image/png'));
  //   console.log(blob);
  //   var form = document.createElement('form');
  //   form.method = 'post';
  //   form.action = '{% url 'upload_answer' %}';
  //   form.innerHTML+='<input type="hidden" name="csrfmiddlewaretoken" value="{{csrf_token}}">';
  //   var input1 = document.createElement('input');
  //   input1.type = 'hidden';
  //   input1.name = "qnumber";
  //   input1.value = currentQNo;
  //   form.appendChild(input1);
  //   var input2 = document.createElement('input');
  //   input2.type = 'file';
  //   input2.name = "file";
  //   input2.value = blob;
  //   form.appendChild(input2);
  //   document.body.appendChild(form);
  //   form.submit();
  //   // let csrftoken = getCookie('csrftoken');
  //   // let response = await fetch('{% url 'upload_answer' %}', {
  //   //   method: 'POST',
  //   //   headers: {
  //   //     "X-CSRFToken": csrftoken
  //   //   },
  //   //   body: blob
  //   // });
  //
  //   // the server responds with confirmation and the image size
  //   let result = await response.json();
  //   alert(result.message);
  // }

  function grayer(formId, yesNo) {
    var f = document.getElementById(formId), s, opacity;
    s = f.style;
    opacity = yesNo? '40' : '100';
    s.opacity = s.MozOpacity = s.KhtmlOpacity = opacity/100;
    s.filter = 'alpha(opacity='+opacity+')';
  }

  // function imgFormSubmit(e) {
  //   e.preventDefault();
  //   if (answer_text=="") {
  //     grayer('img-form', true);
  //     document.getElementById('img-form').submit();
  //     document.getElementById('img-form-submit-btn').value='Processing';
  //     document.getElementById('img-form-submit-btn').disabled=true;
  //   }
  //   else {
  //     openImgSubmitPopup();
  //     return false;
  //   }
  // }


  function txtFormSubmit(e) {
    e.preventDefault();
    if (!document.getElementById('file1')) {
      document.getElementById('loading-overlay').style.display="block";
      let form=document.getElementById('txt-form');
      fetch(form.action, {
        method: form.method,
        body: new FormData(form),
      })
      .then(()=>{
        unsaved=false;
        document.getElementById('loading-overlay').style.display="none";
        getQuestion(currentQNo);
      });
    }
    else {
      e.preventDefault();
      openTxtSubmitPopup();
      return false;
    }
  }

  // function openImgSubmitPopup() {
  //   document.getElementById('img-submit-popup').style.display="block";
  // }

  function openTxtSubmitPopup() {
    document.getElementById('txt-submit-popup').style.display="block";
  }

  document.addEventListener("submit", (e) => {
    // Store reference to form to make later code easier to read
    const form = e.target;
    if (form.id != 'txt-form') {
      document.getElementById('loading-overlay').style.display="block";
      // Post data using the Fetch API
      fetch(form.action, {
        method: form.method,
        body: new FormData(form),
      })
      .then(()=>{
        unsaved=false;
        document.getElementById('loading-overlay').style.display="none";
        getQuestion(currentQNo);
      });

      // Prevent the default form submit
      e.preventDefault();
    }
  });

  function proctorStart() {

    document.getElementById('videos-container').after(document.getElementById('videos-container-prev-ele'));

    currentQNo=1;
    initQuestionJS();
    getQuestion(1);

    var username="{{user.username}}";
    let total_time=1020*3600;

    function sendLogLeft(log) {
      // No need to edit anything in this function
      if (log["actionCommited"]!="right clicked") {
        document.getElementById('proctor-warning').style.display="block";
      }
      let csrftoken = getCookie('csrftoken');
      fetch("{% url 'log_view' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(log)
      });
      console.log(log);
      logSocket.send(JSON.stringify({
        "log": JSON.stringify(log)
      }));
    }

    function sendLogReturned(log) {
      // No need to edit anything in this function
      let csrftoken = getCookie('csrftoken');
      fetch("{% url 'log_view' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(log)
      });
      console.log(log);
      logSocket.send(JSON.stringify({
        "log": JSON.stringify(log)
      }));
    }

    //Fullscreen on click
    function fullScreen(){
      addEventListener("click", function() {
        try {
          var el = document.documentElement;
          var rfs =el.requestFullScreen || el.webkitRequestFullScreen || el.mozRequestFullScreen;
          rfs.call(el);
        }
        catch (e) {
          console.error("Fullscreen not possible");
        }
      });
    };

    var log = {};
    //If the user leaves the tab
    // document.addEventListener("visibilitychange",function(){
    //   sendLogLeft(log);
    //   if (document.visibilityState=="hidden"){
    //     log["username"] = username;
    //     log["time"]=testTime;
    //     log["actionCommited"]="leftPortal";
    //     sendLogLeft(log);
    //   }
    // }, false);

    document.onkeypress = function (event) {
      event = (event || window.event);
      if (event.keyCode == 123) {
        return false;
      }
    }
    document.onmousedown = function (event) {
      event = (event || window.event);
      if (event.keyCode == 123) {
        return false;
      }
    }
    document.onkeydown = function (event) {
      event = (event || window.event);
      if (event.keyCode == 123) {
        return false;
      }
      else if ((event.ctrlKey && event.shiftKey && event.keyCode == 73) || (event.ctrlKey && event.shiftKey && event.keyCode == 74)) {
        return false;
      }
    }

    //Disable right clicks
    document.addEventListener('contextmenu', function(e) {
      log={};
      log["username"] = username;
      var hms = document.querySelector('.time').innerHTML.split(' ')[0];   // your input string
      var a = hms.split(':'); // split it at the colons

      // minutes are worth 60 seconds. Hours are worth 60 minutes.
      var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);
      var testTime=total_time-(seconds)+20*60;
      log["time"]=testTime;
      log["actionCommited"]="right clicked";
      log["windowOuterHeight"]=window.outerHeight;
      log["windowInnerHeight"]=window.innerHeight;
      sendLogLeft(log);
      e.preventDefault();
    }, false);

    //If user exits the fullscreen
    function onFullScreenChange() {
      if (document.fullscreenElement==null && document.mozFullScreenElement==null && document.webkitFullscreenElement==null) {
        log["username"] = username;
        var hms = document.querySelector('.time').innerHTML.split(' ')[0];   // your input string
        var a = hms.split(':'); // split it at the colons

        // minutes are worth 60 seconds. Hours are worth 60 minutes.
        var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);
        var testTime=total_time-(seconds)+20*60;
        log["time"]=testTime;
        log["actionCommited"]="exited fullscreen";
        log["windowOuterHeight"]=window.outerHeight;
        log["windowInnerHeight"]=window.innerHeight;
        sendLogLeft(log);
      }
      else {
        document.getElementById('start-screen').style.display="none";
      }
    };

    document.addEventListener("fullscreenchange", onFullScreenChange, false);
    document.addEventListener("webkitfullscreenchange", onFullScreenChange, false);
    document.addEventListener("mozfullscreenchange", onFullScreenChange, false);

    document.getElementById('proctor-warning-close').onclick=()=>{
      document.getElementById('proctor-warning-close').closest('.popup').style.display="none";
      var hms = document.querySelector('.time').innerHTML.split(' ')[0];   // your input string
      var a = hms.split(':'); // split it at the colons

      // minutes are worth 60 seconds. Hours are worth 60 minutes.
      var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);
      var testTime=total_time-(seconds)+20*60;
      var log = {"username": username, "time": testTime};
      log["windowOuterHeight"]=window.outerHeight;
      log["windowInnerHeight"]=window.innerHeight;
      // Add keys to variable 'log' - "username" and "time"
      sendLogReturned(log);
    };

    document.getElementById('start-screen').style.display="block";
    fullScreen();

    var browserPrefixes = ['moz', 'ms', 'o', 'webkit'],
    isVisible = true; // internal flag, defaults to true

    // get the correct attribute name
    function getHiddenPropertyName(prefix) {
      return (prefix ? prefix + 'Hidden' : 'hidden');
    }

    // get the correct event name
    function getVisibilityEvent(prefix) {
      return (prefix ? prefix : '') + 'visibilitychange';
    }

    // get current browser vendor prefix
    function getBrowserPrefix() {
      for (var i = 0; i < browserPrefixes.length; i++) {
        if(getHiddenPropertyName(browserPrefixes[i]) in document) {
          // return vendor prefix
          return browserPrefixes[i];
        }
      }

      // no vendor prefix needed
      return null;
    }

    // bind and handle events
    var browserPrefix = getBrowserPrefix(),
    hiddenPropertyName = getHiddenPropertyName(browserPrefix),
    visibilityEventName = getVisibilityEvent(browserPrefix);

    function onVisible() {
      // prevent double execution
      if(isVisible) {
        return;
      }

      // change flag value
      isVisible = true;
    }

    function onHidden() {
      // prevent double execution
      if(!isVisible) {
        return;
      }

      // change flag value
      isVisible = false;
      log["username"] = username;
      var hms = document.querySelector('.time').innerHTML.split(' ')[0];   // your input string
      var a = hms.split(':'); // split it at the colons

      // minutes are worth 60 seconds. Hours are worth 60 minutes.
      var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);
      var testTime=total_time-(seconds)+20*60;
      log["time"]=testTime;
      log["actionCommited"]="left the portal window";
      log["windowOuterHeight"]=window.outerHeight;
      log["windowInnerHeight"]=window.innerHeight;
      sendLogLeft(log);
    }

    function handleVisibilityChange(forcedFlag) {
      // forcedFlag is a boolean when this event handler is triggered by a
      // focus or blur eventotherwise it's an Event object
      if(typeof forcedFlag === "boolean") {
        if(forcedFlag) {
          return onVisible();
        }

        return onHidden();
      }

      if(document[hiddenPropertyName]) {
        return onHidden();
      }

      return onVisible();
    }

    document.addEventListener(visibilityEventName, handleVisibilityChange, false);

    // extra event listeners for better behaviour
    document.addEventListener('focus', function() {
      handleVisibilityChange(true);
    }, false);

    document.addEventListener('blur', function() {
      handleVisibilityChange(false);
    }, false);

    window.addEventListener('focus', function() {
      handleVisibilityChange(true);
    }, false);

    window.addEventListener('blur', function() {
      handleVisibilityChange(false);
    }, false);


    window.onresize = function() {
      if ((window.outerHeight - window.innerHeight) > 100) {
        if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement) {
          log["username"] = username;
          var hms = document.querySelector('.time').innerHTML.split(' ')[0];   // your input string
          var a = hms.split(':'); // split it at the colons

          // minutes are worth 60 seconds. Hours are worth 60 minutes.
          var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);
          var testTime=total_time-(seconds)+20*60;
          log["time"]=testTime;
          log["actionCommited"]="may have opened Inspect Element";
          log["windowOuterHeight"]=window.outerHeight;
          log["windowInnerHeight"]=window.innerHeight;
          sendLogLeft(log);
        }
      }
    }
  }


</script>
