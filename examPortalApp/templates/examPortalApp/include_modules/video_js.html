<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.0/simplepeer.min.js" integrity="sha512-0f7Ahsuvr+/P2btTY4mZIw9Vl23lS6LY/Y7amdkmUg2dqsUF+cTe4QjWvj/NIBHJoGksOiqndKQuI9yzn2hB0g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">

  function joinCall() {
    document.getElementById('videos-container').style.display="flex";
    document.getElementById('join-call-btn').remove();


    const videoSignalSocket = new WebSocket(
      ws_scheme+'://'
      + window.location.host
      + '/ws/video-signal/'
      + roomName
      + '/'
    );

    /**
     * The stream object used to send media
     */
    let localStream = null;
    /**
     * All peer connections
     */
    let peers = {}

    // redirect if not https
    if(location.href.substr(0,5) !== 'https')
        location.href = 'https' + location.href.substr(4, location.href.length - 4)


    //////////// CONFIGURATION //////////////////

    /**
     * RTCPeerConnection configuration
     */
    const configuration = {
      iceservers: [
        {
          url: 'turn:52.66.187.16:3478',
          username: 'mimamsa',
          credential: 'mimamsa',
        },

        {
          urls: ["stun:stun.l.google.com:19302", "stun:stun1.l.google.com:19302", "stun:stun2.l.google.com:19302", "stun:stun3.l.google.com:19302", "stun:stun3.l.google.com:19302"]
        }
      ]
    }

    /**
     * UserMedia constraints
     */
    let constraints = {
      video: true,
      audio: true,
      width: { max: 640 },
      height: { max: 400 },
      frameRate: { max: 30 },
      facingMode: { exact: "user" }
    }

    /////////////////////////////////////////////////////////

    constraints.video.facingMode = {
        ideal: "user"
    }

    // enabling the camera at startup
    navigator.mediaDevices.getUserMedia(constraints).then(stream => {
        console.log('Received local stream');

        document.getElementById('video-{{team.team_id}}-{{self_peer_id}}').srcObject=stream;
        localStream = stream;

        init()

    }).catch(e => alert(`getusermedia error ${e.name}`))

    /**
     * initialize the socket connections
     */
    function init() {

        videoSignalSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          if (data.message == "initReceive") {
            console.log('INIT RECEIVE ' + data.id)
            addPeer(data.id, false)
            videoSignalSocket.send(JSON.stringify({
              "message": 'initSend',
              "id":data.id,
            }));
          }
          else if (data.message == 'initSend') {
            console.log('INIT SEND ' + data.id)
            addPeer(data.id, true)
          }
          else if (data.message == 'removePeer') {
            console.log('removing peer ' + data.id)
            removePeer(data.id)
          }
          // else if (data.message == 'signal') {
          //   peers[data.id].signal(data.signal)
          // }
        }

        videoSignalSocket.onclose = function(e) {
          console.log('GOT DISCONNECTED')
          for (let id in peers) {
            removePeer(id)
          }
        }
    }


    function removePeer(id) {

        let videoEl = document.getElementById(id)
        if (videoEl) {

            const tracks = videoEl.srcObject.getTracks();

            tracks.forEach(function (track) {
                track.stop()
            })

            videoEl.srcObject = null
        }
        if (peers[id]) peers[id].destroy()
        delete peers[id]
    }


    function addPeer(id, am_initiator) {
        peers[id] = new SimplePeer({
            initiator: am_initiator,
            stream: localStream,
            config: configuration
        })

        // peers[id].on('signal', data => {
        //     videoSignalSocket.send(JSON.stringify({
        //       "message": 'signal',
        //       "signal": data,
        //       "id": id,
        //     }));
        // })

        peers[id].on('stream', stream => {
            let newVid = document.getElementById(id)
            newVid.srcObject = stream
            newVid.playsinline = false
            newVid.autoplay = true
            newVid.className = "vid"
        })
    }

  }
</script>
