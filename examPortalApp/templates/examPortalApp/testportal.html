{% extends 'examPortalApp/body.html' %}
{% load mathfilters %}

{% block script %}
  <script type="text/javascript">
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    function startTimer(datetime, display) {
      var start = Date.now(),
        diff,
        minutes,
        seconds;
      function timer() {

        diff = ((datetime - Date.now()) / 1000);

        // does the same job as parseInt truncates the float
        days = (diff / (60 * 60 * 24)) | 0;
        diff = (diff % (60 * 60 * 24)) | 0;
        hours = (diff / (60 * 60)) | 0;
        diff = (diff % (60 * 60)) | 0;
        minutes = (diff / 60) | 0;
        seconds = (diff % 60) | 0;
        if (days > 0) {
          display.textContent = days + " days " + hours + " hours " + minutes + " minutes and " + seconds + " seconds";
        }
        else if (hours > 0) {
          display.textContent = hours + " hours " + minutes + " minutes and " + seconds + " seconds";
        }
        else if (minutes > 0) {
          display.textContent = minutes + " minutes and " + seconds + " seconds";
        }
        else {
          display.textContent = seconds + " seconds";
        }
        if (diff <= 0) {
          // add one second so that the count down starts at the full duration
          // example 05:00 not 04:59
          start = Date.now() + 1000;
        }
      };
      // we don't want to wait a full second before the timer starts
      timer();
      setInterval(timer, 1000);
    };


    function display_question_numbers(que_display) {
      var content = "";
      for (i = 0; i < {{ QCount }}; i++) {
      if (i + 1 == {{ QNum }}) {
      content += "<button onclick='getQuestion(" + (i + 1) + ")' class='btn visited active btn-primary btn-md'> " + (i + 1) + " </button>";
    }
        else {
      content += "<button onclick='getQuestion(" + (i + 1) + ")'class='btn btn-primary btn-md'> " + (i + 1) + " </button>";
    }
      };
    que_display.innerHTML = content;
    };

    window.onload = function () {
      var d = new Date();
      d.setUTCDate({{ UTCDate }});
      d.setUTCMonth({{ UTCMonth }}-1);
      d.setUTCFullYear({{ UTCYear }});
      d.setUTCHours({{ UTCHours }});
      d.setUTCMinutes({{ UTCMinutes }});
      d.setUTCSeconds({{ UTCSeconds }});
      console.log(d);
      var display = document.querySelector('#time');
      startTimer(d.getTime(), display);
      var que_display = document.querySelector('#questions')
      display_question_numbers(que_display);
    };

    var currentQNo;


    function getQuestion(questionNumber) {
      console.log(questionNumber);
      window.location.href = ("{% url 'test_no' qnumber=1 %}").substring(0, ("{% url 'test_no' qnumber=1 %}").length - 1) + questionNumber;
    }

    function nextQuestion() {
      if (currentQNo < {{ QCount }})
      {
        currentQNo += 1;
        getQuestion(currentQNo);
        // Qactive(currentQNo);
      }
    }

    function prevQuestion() {
      if (currentQNo > 1) {
        currentQNo -= 1;
        getQuestion(currentQNo);
        // Qactive(currentQNo);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      currentQNo = {{ QNum }};
      if (currentQNo == 1) {
        document.getElementById('prev').setAttribute("disabled", "disabled")
      }
      if (currentQNo == {{ QCount }})
      {
        document.getElementById('next').setAttribute("disabled", "disabled");
      }
      fetchAnswers();
      // getQuestion(currentQNo);
    });

    {% if QType == 's' %}
    function fetchAnswers() {
      document.getElementById('uploadedAnswers').innerHTML = "Loading";
      fetch(("{% url 'get_answers' qnumber=1 %}").substring(0, ("{% url 'get_answers' qnumber=1 %}").length - 1) + currentQNo)
        .then(response => response.json())
        .then((data) => {
          document.getElementById('uploadedAnswers').innerHTML = "";
          var URIList = data["images"];
          for (var i = 0; i < URIList.length; i++) {
            var URI = URIList[i];
            document.getElementById('uploadedAnswers').innerHTML += "<img width='200' src='" + URI + "'>";
          }
        })
    }
    {% elif QType == 'm' %}
    function fetchAnswers() {
      fetch(("{% url 'get_m_answers' qnumber=1 %}").substring(0, ("{% url 'get_m_answers' qnumber=1 %}").length - 1) + currentQNo)
        .then(response => response.json())
        .then((data) => {
          var marked_answers = data["answers"];
          for (var i = 0; i < marked_answers.length; i++) {
            document.getElementById('mcq-btn-'+marked_answers[i].toString()).checked=true;
          }
        })
    }
    {% elif QType == 't' %}
    function fetchAnswers() {
      fetch(("{% url 'get_t_answers' qnumber=1 %}").substring(0, ("{% url 'get_t_answers' qnumber=1 %}").length - 1) + currentQNo)
        .then(response => response.json())
        .then((data) => {
          var choice = data["choice"];
          if (choice>0) {
            document.getElementById('tt-btn-'+choice.toString()).checked=true;
          }
        })
      document.getElementById('uploadedAnswers').innerHTML = "Loading";
      fetch(("{% url 'get_answers' qnumber=1 %}").substring(0, ("{% url 'get_answers' qnumber=1 %}").length - 1) + currentQNo)
        .then(response => response.json())
        .then((data) => {
          document.getElementById('uploadedAnswers').innerHTML = "";
          var URIList = data["images"];
          for (var i = 0; i < URIList.length; i++) {
            var URI = URIList[i];
            document.getElementById('uploadedAnswers').innerHTML += "<img width='200' src='" + URI + "'>";
          }
        })
    }
    {% endif %}

  </script>
{% endblock %}


{% block content %}

  <div class="container">
    <h2>The quiz will end in: <div id="time"></div>
    </h2>
    <hr>
    <div class="row">
      <div class="col-lg-9 ">


        <div id="questions"></div>
        <div id="content">{{content|safe}}</div>
        {% if QType == 'm' %}
        <form action="{% url 'save_m_answer' %}" method="post">
          {% csrf_token %}
          {% for option_set in options %}
          {% for option in option_set %}
          {% if forloop.counter0 == 0 %}
          <h5>{{option}}</h5>
          {% else %}
          <label for="opt-{{forloop.parentloop.counter0|mul:4|add:forloop.counter0}}">{{option}}</label>
          <input id="mcq-btn-{{forloop.parentloop.counter0|mul:4|add:forloop.counter0}}" type="radio" name="choice-{{forloop.parentloop.counter}}" value="{{forloop.parentloop.counter0|mul:4|add:forloop.counter0}}">
          {% endif %}
          {% endfor %}
          {% endfor %}
          <br>
          <input id="qnumber" type="hidden" name="qnumber" value="{{QNum}}">
          <input type="submit" name="" value="Save Answer">
        </form>
        {% elif QType == 't' %}
        <form action="{% url 'save_t_answer' %}" method="post">
          {% csrf_token %}
          <h5>Options</h5>
          {% for option in options %}
          <label for="opt-{{forloop.counter}}">{{option}}</label>
          <input id="tt-btn-{{forloop.counter}}" type="radio" name="choice" value="{{forloop.counter}}">
          {% endfor %}
          <br>
          <input id="qnumber" type="hidden" name="qnumber" value="{{QNum}}">
          <input type="submit" name="" value="Save Choice">
        </form>
        <form action="{% url 'upload_answer' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="fieldWrapper" id="fileFieldWrapper">
            <label for="id_file">Upload answers:</label>
            <input type="file" name="file" required id="id_file">
          </div>
          <input id="qnumber" type="hidden" name="qnumber" value="{{QNum}}">
          <input type="submit" name="" value="Submit">
        </form>
        <div id="uploadedAnswers">

        </div>
        {% elif QType == 's' %}
        <form action="{% url 'upload_answer' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="fieldWrapper" id="fileFieldWrapper">
            <label for="id_file">Upload answers:</label>
            <input type="file" name="file" required id="id_file">
          </div>
          <input id="qnumber" type="hidden" name="qnumber" value="{{QNum}}">
          <input type="submit" name="" value="Submit">
        </form>
        <div id="uploadedAnswers">

        </div>
        {% endif %}
        <div id="nav_buttons">
          <button onclick="prevQuestion();" id="prev" type="button" class="btn btn-secondary btn-lg">Previous</button>
          <button onclick="nextQuestion();" id="next" type="button" class="btn btn-secondary btn-lg"
            style="float: right;">Next</button>
        </div>
      </div>
      <div id="members" class="col-lg-3">
        <h3>Team members<h3>
      </div>
    </div>
  </div>

{% endblock %}
