{% load static %}

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Mimamsa Quiz Portal</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link href="{% static 'examPortalApp/css/styles.css' %}" rel="stylesheet">
    <script type="text/javascript">
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    function startTimer(datetime, display) {
      var start = Date.now(),
          diff,
          minutes,
          seconds;
      function timer() {

          diff = ((datetime - Date.now()) / 1000);

          // does the same job as parseInt truncates the float
          days = (diff / (60*60*24)) | 0;
          diff = (diff % (60*60*24)) | 0;
          hours = (diff / (60*60)) | 0;
          diff = (diff % (60*60)) | 0;
          minutes = (diff / 60) | 0;
          seconds = (diff % 60) | 0;
          if (days>0)
          {
            display.textContent = days + " days " + hours + " hours " + minutes + " minutes and " + seconds + "seconds";
          }
          else if (hours>0) {
            display.textContent = hours + " hours " + minutes + " minutes and " + seconds + "seconds";
          }
          else if (minutes>0) {
            display.textContent = minutes + " minutes and " + seconds + "seconds";
          }
          else {
            display.textContent = seconds + "seconds";
          }
          if (diff <= 0) {
              // add one second so that the count down starts at the full duration
              // example 05:00 not 04:59
              start = Date.now() + 1000;
          }
      };
      // we don't want to wait a full second before the timer starts
      timer();
      setInterval(timer, 1000);
    }

    window.onload = function () {
      var d = new Date();
      d.setUTCDate({{UTCDate}});
      d.setUTCMonth({{UTCMonth}}-1);
      d.setUTCFullYear({{UTCYear}});
      d.setUTCHours({{UTCHours}});
      d.setUTCMinutes({{UTCMinutes}});
      d.setUTCSeconds({{UTCSeconds}});
      console.log(d);
      var display = document.querySelector('#time');
      startTimer(d.getTime(), display);
    };

    var currentQNo;

    function getQuestion(questionNumber) {
      console.log(questionNumber);
      // fetch(("{% url 'get_question' qnumber=1 %}").substring(0, ("{% url 'get_question' qnumber=1 %}").length - 1) + questionNumber)
      //   .then(response=>response.json())
      //   .then((data) => {
      //     document.getElementById('content').innerHTML=data["content"];
      //   })
      // fetchAnswers();
      window.location.href = ("{% url 'test_no' qnumber=1 %}").substring(0, ("{% url 'get_question' qnumber=1 %}").length - 1) + questionNumber;
    }

    function nextQuestion() {
      if (currentQNo < {{QCount}})
      {
        currentQNo+=1;
        getQuestion(currentQNo);
        if (currentQNo == {{QCount}})
        {
          document.getElementById('next').setAttribute("disabled", "disabled");
        }
        if (currentQNo == 2)
        {
          document.getElementById('prev').removeAttribute("disabled");
        }
        document.getElementById('qnumber').value=currentQNo;
      }
    }

    function prevQuestion() {
      if (currentQNo > 1)
      {
        currentQNo-=1;
        getQuestion(currentQNo);
        if (currentQNo == 1)
        {
          document.getElementById('prev').setAttribute("disabled", "disabled")
        }
        if (currentQNo == ({{QCount}} - 1))
        {
          document.getElementById('next').removeAttribute("disabled")
        }
        document.getElementById('qnumber').value=currentQNo;
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      currentQNo = 1;
      getQuestion(currentQNo);
    });

    function fetchAnswers() {
      document.getElementById('uploadedAnswers').innerHTML="Loading";
      fetch(("{% url 'get_answers' qnumber=1 %}").substring(0, ("{% url 'get_answers' qnumber=1 %}").length - 1) + currentQNo)
        .then(response=>response.json())
        .then((data)=>{
          document.getElementById('uploadedAnswers').innerHTML="";
          var URIList=data["images"];
          for (var i = 0; i < URIList.length; i++) {
            var URI=URIList[i];
            document.getElementById('uploadedAnswers').innerHTML+="<img width='200' src='"+URI+"'>";
          }
        })
    }

    // function submitAnswer() {
    //   var input = document.querySelector('input[type="file"]');
    //   var file=input.files[0];
    //   fetch("{% url 'upload_answer' %}", {
    //     method: 'POST',
    //     credentials: 'same-origin',
    //     headers: {
    //       "X-CSRFToken": getCookie("csrftoken")
    //     },
    //     body: file,
    //   })
    //     .then(()=>{
    //       fetchAnswers()
    //     })
    // }

    </script>
  </head>
  <body>
    <div>
      <h2>The quiz will end in</h2>
      <div id="time">
      </div>
    </div>
    <div id="content">
      {{content}}
    </div>
    <form action="{% url 'upload_answer' %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="fieldWrapper" id="fileFieldWrapper">
          <label for="id_file">Upload answers:</label>
          <input type="file" name="file" required id="id_file">
      </div>
      <input id="qnumber" type="hidden" name="qnumber" value="1">
      <input type="submit" name="" value="Submit">
    </form>
    <div id="uploadedAnswers">

    </div>
    <button onclick="prevQuestion()" id="prev" type="button" class="btn btn-secondary btn-lg" disabled>Previous</button>
    <button onclick="nextQuestion()" id="next" type="button" class="btn btn-secondary btn-lg">Next</button>
  </body>
</html>
