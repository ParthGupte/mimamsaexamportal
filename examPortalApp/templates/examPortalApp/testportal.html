{% extends 'examPortalApp/body.html' %}
{% load mathfilters %}
{% load staticfiles%}

{% block script %}
  {% include 'examPortalApp/include_modules/testportal_js.html' %}
{% endblock %}

{% block header_center %}
<div class="time"></div>
{% endblock %}

{% block sidepane %}
<div class="sidepane-timer">
<div class="time"></div>
<br><hr><br>
</div>
<div id="members">
  <h3>Team id:</h3>
  <h4>{{team.team_id}}</h4>
  <br>
  <h3>Team members:</h3>
  {% for member in team.users.all %}
  {{member}}<br>
  {% endfor %}
</div>
<br><hr><br>
<ul class="list-group">
  <li class=""><a href="{% url 'index' %}">Dashboard</a></li>
  <li class=""><a href="{% url 'logout' %}">Log Out</a></li>
</ul>
<br><br><br>
{% endblock %}

{% block content %}

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="alert alert-info"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <div class="fluid-container">
    <div class="row">
      <div class="col-lg-12">
        <div id="nav-questions">
          {% for i in ''|center:QCount %}
            <button onclick='getQuestion({{forloop.counter}})' class='btn {% if forloop.counter == QNum %}visited active{% endif %} {% if forloop.counter in review_questions %}btn-review{% elif forloop.counter in answered_questions %}btn-answered{% endif %} btn-primary btn-md'>{{forloop.counter}}</button>
          {% endfor %}
        </div>
        <div id="q-content">{{content|safe}}</div>

        <!-- Popups -->

        <div id="img-submit-popup" class="popup">
          <div class="popup-message">
            <p>
              A text based answer was already submitted for this question. Uploading an image would delete the former.
            </p>
            <button onclick="document.getElementById('img-form').submit()">Continue</button>
            <button onclick="closePopup(this)">Go back</button>
          </div>
        </div>
        <div id="txt-submit-popup" class="popup">
          <div class="popup-message">
            <p>
              An uploaded image was already submitted for this question. Submitting a text based answer would delete the former.
            </p>
            <button onclick="document.getElementById('txt-form').submit()">Continue</button>
            <button onclick="closePopup(this)">Go back</button>
          </div>
        </div>
        <div id="save-changes-popup" class="popup">
          <div class="popup-message">
            <p>
              You've made unsaved changes to your answer. Discard changes and continue?
            </p>
            <button id="save-changes-popup-continue">Continue</button>
            <button onclick="closePopup(this)">Go back</button>
          </div>
        </div>
        <div id="camera-popup" class="popup">
          <div class="popup-message">
            <div class="camera">
              <video id="video">Video stream not available.</video>
            </div>
            <div><button id="startbutton">Take photo</button></div>
            <div><button id="upload-photo-btn">Upload photo</button></div>
            <canvas id="canvas"></canvas>
            <div class="output">
              <img id="photo" alt="The screen capture will appear in this box.">
            </div>
            <button id="close-cam-btn" type="button" name="button" onclick="closeCamPopup(this)">Close</button>
          </div>
        </div>

        <!-- End popups -->

        <div class="answer-section">


          {% if QType == 'm' %}


          <form action="{% url 'save_m_answer' %}" method="post">
            {% csrf_token %}
            {% for option_set in options %}
              {% for option in option_set %}
                {% if forloop.counter0 == 0 %}
                  <h5>{{option}}</h5>
                {% else %}
                  <label for="opt-{{forloop.parentloop.counter0|mul:4|add:forloop.counter0}}">{{option}}</label>
                  <input {% if forloop.parentloop.counter0|mul:4|add:forloop.counter0 in selected_options %}checked{% endif %} id="mcq-btn-{{forloop.parentloop.counter0|mul:4|add:forloop.counter0}}" oninput="answerChange()" type="radio" name="choice-{{forloop.parentloop.counter}}" value="{{forloop.parentloop.counter0|mul:4|add:forloop.counter0}}">
                {% endif %}
              {% endfor %}
            {% endfor %}
            <br>
            <input id="qnumber" type="hidden" name="qnumber" value="{{QNum}}">
            <input type="reset" onclick="return resetForm(this.form);" value="Clear Response">
            <br>
            <input type="submit" name="" value="Save Answer">
          </form>
          {% if answer_status != 'r' %}
            <button id="mark-review-btn-inactive" type="button" name="review" onclick="markReview()">Mark for Review</button>
          {% else %}
            <button id="mark-review-btn-active" type="button" name="review" onclick="markUnanswered()">Marked for Review</button>
          {% endif %}


          {% elif QType == 't' %}


          {% if selected_options|length == 0 %}
            <h5>1) Choose option:</h5>
            <form action="{% url 'save_t_answer' %}" method="post">
              {% csrf_token %}
              {% for option in options %}
                <label for="opt-{{forloop.counter}}">{{option}}</label>
                <input {% if forloop.counter in selected_options %}checked{% endif %} id="tt-btn-{{forloop.counter}}" oninput="answerChange()" type="radio" name="choice" value="{{forloop.counter}}">
              {% endfor %}
              <br>
              <input id="qnumber" type="hidden" name="qnumber" value="{{QNum}}">
              <input type="reset" onclick="return resetForm(this.form);" value="Clear Response">
              <br>
              <input type="submit" name="" value="Save Choice">
            </form>
          {% else %}
            {% for option in options %}
              {% if forloop.counter in selected_options %}
                <h5>Chosen option: {{option}}</h5>
              {% endif %}
            {% endfor %}
            <a href="{% url 'clear_t_options' qnumber=QNum %}">Select a different option</a>
            <br><br>
            <h5>2) Upload/Type explanation:</h5>

            {% include 'examPortalApp/include_modules/forms_card.html' %}

            <br><br>
          {% endif %}

          {% if selected_options|length != 0 %}
              {% if answer_status != 'a' %}
                <button id="mark-answered-btn-inactive" type="button" name="review" onclick="markAnswered()">Mark as Answered</button>
              {% else %}
                <button id="mark-answered-btn-active" type="button" name="review" onclick="markUnanswered()">Marked as Answered</button>
              {% endif %}
            {% endif %}
            {% if answer_status != 'r' %}
              <button id="mark-review-btn-inactive" type="button" name="review" onclick="markReview()">Mark for Review</button>
            {% else %}
            <button id="mark-review-btn-active" type="button" name="review" onclick="markUnanswered()">Marked for Review</button>
          {% endif %}


          {% elif QType == 's' %}

            {% include 'examPortalApp/include_modules/forms_card.html' %}

            <br><br>

            {% if answer_status != 'a' %}
              <button id="mark-answered-btn-inactive" type="button" name="review" onclick="markAnswered()">Mark as Answered</button>
            {% else %}
              <button id="mark-answered-btn-active" type="button" name="review" onclick="markUnanswered()">Marked as Answered</button>
            {% endif %}

            {% if answer_status != 'r' %}
              <button id="mark-review-btn-inactive" type="button" name="review" onclick="markReview()">Mark for Review</button>
            {% else %}
              <button id="mark-review-btn-active" type="button" name="review" onclick="markUnanswered()">Marked for Review</button>
            {% endif %}

          {% endif %}

          <div id="nav_buttons">
            <button onclick="prevQuestion();" id="prev" type="button" class="btn btn-secondary btn-lg">Previous</button>
            <button onclick="nextQuestion();" id="next" type="button" class="btn btn-secondary btn-lg" style="float: right;">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% if QType == 's' %}
  <script type="text/javascript" src="{% static 'examPortalApp/js/camera.js' %}"></script>
  {% elif QType == 't' %}
    {% if selected_options|length != 0 %}
    <script type="text/javascript" src="{% static 'examPortalApp/js/camera.js' %}"></script>
    {% endif %}
  {% endif %}
{% endblock %}
